name: Release

# Triggered manually via GitHub Actions UI or /release skill
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'CalVer version (e.g., 26.1.3001)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (markdown)'
        required: false
        type: string
        default: ''
      run_id:
        description: 'CI workflow run ID to download artifacts from (leave empty for latest)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate CalVer format
        run: |
          VERSION="${{ inputs.version }}"
          # CalVer format: YY.M.DDRR (e.g., 26.1.3001)
          if ! echo "$VERSION" | grep -Eq '^[0-9]{2}\.[0-9]{1,2}\.[0-9]{3,4}$'; then
            echo "Invalid CalVer format: $VERSION"
            echo "Expected format: YY.M.DDRR (e.g., 26.1.3001)"
            exit 1
          fi
          echo "Valid CalVer version: $VERSION"

      - name: Get CI run ID
        id: get-run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.run_id }}" ]; then
            RUN_ID="${{ inputs.run_id }}"
          else
            # Get latest successful CI run on main
            RUN_ID=$(gh run list --workflow=ci.yml --branch=main --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
          fi

          if [ -z "$RUN_ID" ]; then
            echo "No successful CI run found"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Using CI run: $RUN_ID"

      - name: Download all artifacts from CI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          rm -rf artifacts
          mkdir -p artifacts
          gh run download ${{ steps.get-run.outputs.run_id }} --dir artifacts
          echo "Downloaded artifacts:"
          ls -R artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Update version files
        run: |
          VERSION="${{ inputs.version }}"

          # Update desktop/package.json
          jq ".version = \"$VERSION\"" desktop/package.json > tmp.json && mv tmp.json desktop/package.json

          # Update desktop/src-tauri/tauri.conf.json
          jq ".version = \"$VERSION\"" desktop/src-tauri/tauri.conf.json > tmp.json && mv tmp.json desktop/src-tauri/tauri.conf.json

          # Update desktop/src-tauri/Cargo.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" desktop/src-tauri/Cargo.toml

          # Update sdk/package.json
          jq ".version = \"$VERSION\"" sdk/package.json > tmp.json && mv tmp.json sdk/package.json

          # Update core/Cargo.toml (via workspace)
          # Update workspace version in root Cargo.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml

          echo "Updated all version files to $VERSION"

      - name: Commit version changes
        run: |
          VERSION="${{ inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Release $VERSION" || echo "No changes to commit"
          git tag "$VERSION"
          git push origin main --tags

      - name: Create GitHub release (treeline repo)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          RELEASE_NOTES="${{ inputs.release_notes }}"

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi

          # Create release
          gh release create "$VERSION" \
            --title "Treeline $VERSION" \
            --notes "$RELEASE_NOTES" \
            || echo "Release may already exist"

          # Upload desktop artifacts (macOS has nested dmg/ and macos/ subdirs)
          for f in artifacts/desktop-macos-arm64/dmg/*.dmg; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done
          for f in artifacts/desktop-macos-arm64/macos/*.app.tar.gz; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done
          for f in artifacts/desktop-macos-arm64/macos/*.sig; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done
          for f in artifacts/desktop-linux-x64/*.AppImage; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done
          for f in artifacts/desktop-linux-x64/*.AppImage.sig; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done
          for f in artifacts/desktop-windows-x64/*.exe; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done
          for f in artifacts/desktop-windows-x64/*.exe.sig; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --clobber || true
          done

          # Upload CLI binaries
          for f in artifacts/cli-linux-x64/tl; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f#tl-linux-x64" --clobber || true
          done
          for f in artifacts/cli-macos-arm64/tl; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f#tl-macos-arm64" --clobber || true
          done
          for f in artifacts/cli-windows-x64/tl.exe; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f#tl-windows-x64.exe" --clobber || true
          done

      - name: Create GitHub release (treeline-releases - dual publish)
        env:
          GH_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          RELEASE_NOTES="${{ inputs.release_notes }}"
          RELEASES_REPO="treeline-money/treeline-releases"

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi

          # Create release in treeline-releases (for existing users)
          gh release create "$VERSION" \
            --repo "$RELEASES_REPO" \
            --title "Treeline $VERSION" \
            --notes "$RELEASE_NOTES" \
            || echo "Release may already exist"

          # Copy latest.json from previous release to maintain production updates
          PREV_RELEASE=$(gh release list --repo "$RELEASES_REPO" --limit 2 --json tagName --jq '.[1].tagName // empty')
          if [ -n "$PREV_RELEASE" ]; then
            echo "Copying latest.json from $PREV_RELEASE"
            gh release download "$PREV_RELEASE" --repo "$RELEASES_REPO" --pattern "latest.json" --dir /tmp || true
            if [ -f /tmp/latest.json ]; then
              gh release upload "$VERSION" /tmp/latest.json --repo "$RELEASES_REPO" --clobber
              rm /tmp/latest.json
            fi
          fi

          # Upload desktop artifacts (macOS has nested dmg/ and macos/ subdirs)
          for f in artifacts/desktop-macos-arm64/dmg/*.dmg; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done
          for f in artifacts/desktop-macos-arm64/macos/*.app.tar.gz; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done
          for f in artifacts/desktop-macos-arm64/macos/*.sig; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done
          for f in artifacts/desktop-linux-x64/*.AppImage; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done
          for f in artifacts/desktop-linux-x64/*.AppImage.sig; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done
          for f in artifacts/desktop-windows-x64/*.exe; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done
          for f in artifacts/desktop-windows-x64/*.exe.sig; do
            [ -f "$f" ] && gh release upload "$VERSION" "$f" --repo "$RELEASES_REPO" --clobber || true
          done

      - name: Generate and upload latest-staging.json
        env:
          GH_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          RELEASE_NOTES="${{ inputs.release_notes }}"
          RELEASES_REPO="treeline-money/treeline-releases"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi
          RELEASE_NOTES_ESCAPED=$(echo "$RELEASE_NOTES" | jq -Rs '.')

          # Read signatures
          LINUX_SIG=""
          MACOS_SIG=""
          WINDOWS_SIG=""

          for f in artifacts/desktop-linux-x64/*.AppImage.sig; do
            [ -f "$f" ] && LINUX_SIG=$(cat "$f") && break
          done

          for f in artifacts/desktop-macos-arm64/macos/*.app.tar.gz.sig; do
            [ -f "$f" ] && MACOS_SIG=$(cat "$f") && break
          done

          for f in artifacts/desktop-windows-x64/*.exe.sig; do
            [ -f "$f" ] && WINDOWS_SIG=$(cat "$f") && break
          done

          # Find artifact filenames
          LINUX_FILE=""
          MACOS_FILE=""
          WINDOWS_FILE=""

          for f in artifacts/desktop-linux-x64/*.AppImage; do
            [ -f "$f" ] && LINUX_FILE=$(basename "$f") && break
          done

          for f in artifacts/desktop-macos-arm64/macos/*.app.tar.gz; do
            [ -f "$f" ] && MACOS_FILE=$(basename "$f") && break
          done

          for f in artifacts/desktop-windows-x64/*.exe; do
            [ -f "$f" ] && WINDOWS_FILE=$(basename "$f") && break
          done

          # Generate latest-staging.json
          echo "{" > latest-staging.json
          echo "  \"version\": \"${VERSION}\"," >> latest-staging.json
          echo "  \"notes\": ${RELEASE_NOTES_ESCAPED}," >> latest-staging.json
          echo "  \"pub_date\": \"${PUB_DATE}\"," >> latest-staging.json
          echo "  \"platforms\": {" >> latest-staging.json

          FIRST_PLATFORM=true

          if [ -n "$LINUX_FILE" ] && [ -n "$LINUX_SIG" ]; then
            if [ "$FIRST_PLATFORM" = false ]; then echo "," >> latest-staging.json; fi
            FIRST_PLATFORM=false
            echo "    \"linux-x86_64\": {" >> latest-staging.json
            echo "      \"signature\": \"${LINUX_SIG}\"," >> latest-staging.json
            echo "      \"url\": \"https://github.com/${RELEASES_REPO}/releases/download/${VERSION}/${LINUX_FILE}\"" >> latest-staging.json
            echo "    }" >> latest-staging.json
          fi

          if [ -n "$MACOS_FILE" ] && [ -n "$MACOS_SIG" ]; then
            if [ "$FIRST_PLATFORM" = false ]; then echo "," >> latest-staging.json; fi
            FIRST_PLATFORM=false
            echo "    \"darwin-aarch64\": {" >> latest-staging.json
            echo "      \"signature\": \"${MACOS_SIG}\"," >> latest-staging.json
            echo "      \"url\": \"https://github.com/${RELEASES_REPO}/releases/download/${VERSION}/${MACOS_FILE}\"" >> latest-staging.json
            echo "    }" >> latest-staging.json
          fi

          if [ -n "$WINDOWS_FILE" ] && [ -n "$WINDOWS_SIG" ]; then
            if [ "$FIRST_PLATFORM" = false ]; then echo "," >> latest-staging.json; fi
            FIRST_PLATFORM=false
            echo "    \"windows-x86_64\": {" >> latest-staging.json
            echo "      \"signature\": \"${WINDOWS_SIG}\"," >> latest-staging.json
            echo "      \"url\": \"https://github.com/${RELEASES_REPO}/releases/download/${VERSION}/${WINDOWS_FILE}\"" >> latest-staging.json
            echo "    }" >> latest-staging.json
          fi

          echo "  }" >> latest-staging.json
          echo "}" >> latest-staging.json

          cat latest-staging.json

          # Upload to treeline-releases repo (using RELEASES_TOKEN)
          gh release upload "$VERSION" latest-staging.json --repo "$RELEASES_REPO" --clobber

      - name: Upload latest-staging.json to treeline repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          gh release upload "$VERSION" latest-staging.json --clobber

      - name: Publish SDK to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "NPM_TOKEN not set, skipping npm publish"
            exit 0
          fi

          VERSION="${{ inputs.version }}"

          # Check if version already exists on npm
          if npm view "@treeline-money/plugin-sdk@$VERSION" version 2>/dev/null; then
            echo "Version $VERSION already published to npm, skipping"
            exit 0
          fi

          # Extract and publish the SDK tarball
          cd artifacts/sdk-npm-package
          npm publish *.tgz --access public

      - name: Post to Discord #staging-releases
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_STAGING }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK_STAGING not set, skipping Discord notification"
            exit 0
          fi

          VERSION="${{ inputs.version }}"
          RELEASE_NOTES="${{ inputs.release_notes }}"

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi
          RELEASE_NOTES_ESCAPED=$(echo "$RELEASE_NOTES" | jq -Rs '.')

          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"Treeline $VERSION Release Candidate\",
                \"description\": $RELEASE_NOTES_ESCAPED,
                \"color\": 16761095,
                \"footer\": {\"text\": \"Release Candidate - Test with ~/.treeline/use-staging-updates then run /promote\"}
              }]
            }"
